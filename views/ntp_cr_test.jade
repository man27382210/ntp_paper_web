extends layout

block body_content
	.page_use
		select#select
			- each cr, i  in ctrl_crs
				option(value="#{cr._id}" data-index="#{i}") #{cr.name}
		#cr
			.name
			.place
			ul#ul
			#demo
			#demo2


	script.

		function ajaxUse(url, callback){
			$.ajax(url, {
				type: 'GET',
				success: function(data) {
					callback(data);
				}
			});
		}
		function ajaxUsePost(url, data, callback){
			$.ajax(url, {
				type: 'POST',
				data: {"arr": data},
				success: function(data) {
					callback(data);
				}
			});
		}

		$(function(){
			var dataSet = !{JSON.stringify(ctrl_crs)};
			$("#select").change(function(){
				var index = $("#select option:selected").data("index");
				var cr = dataSet[index];
				$('.name').html(cr.name);
				$('.place').html(cr.place);
				var id = $(this).val();
				var data_plats_use;
				ajaxUse("/get_plats?cr_id="+id, function(data_plats){
					data_plats_use = data_plats;
					$('#demo').empty();
					var htmlUse = '<table cellpadding="0" cellspacing="0" border="0" class="display" id="example"></table>';
					$('#demo').html(htmlUse);
					var dataUse = [];
					for (var i =0 ; i<data_plats.length; i++){
						var dataPlat = [];
						var plat = data_plats[i];
						dataPlat.push(plat.plat.plat_origin);
						dataPlat.push(plat.origin_ac);
						dataPlat.push(plat.weight_ac);
						dataPlat.push(plat.weight_ac_mince);
						dataPlat.push(plat.weight_ac_with_cor);
						dataPlat.push(plat.weight_ac_with_cor_mince);
						dataPlat.push(plat.bill_list);
						dataUse.push(dataPlat);
					}
					var table = $('#example').DataTable({
						"data": dataUse,
						"iDisplayLength": dataUse.length,
						"width": '100%',
						"columns": [
							{ "title": "政見" , "width": "50%"},
							{ "title": "原始分數" },
							{ "title": "1/4分數" },
							{ "title": "1/4分數(倒扣)" },
							{ "title": "1/4分數加權" },
							{ "title": "1/4分數加權(倒扣)" },
							{ "title": "id", "visible":false},
						]
					});
					$('#example tbody').on( 'click', 'tr', function () {
						var bill_use = [];
					    if ( $(this).hasClass('selected') ) {
					    	var idx = $(this).index();
					    	var bill_list = table.columns(6).data()[0][idx];
					    	for (var i = 0; i<bill_list.length ; i++){
					    		var bill = bill_list[i];
					    		if(bill["cor_value"] > 0.172798086405){
					    			bill_use.push(bill["bill_id"]);
					    		}
					    	}
							$(this).removeClass('selected');
						}else {
							table.$('tr.selected').removeClass('selected');
							$(this).addClass('selected');
						}
						ajaxUsePost('/get_bills',bill_use, function(data){

						});
					});
				});
			});
		});