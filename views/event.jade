extends layout

block body_content

	#event_rotation
		.event
			img(src="/uploads/#{ctrl_event.id}" onload="fitDivEvent(event);", onerror="this.src='';")
	.event_content
		.event_header
			img.event_company_photo
			h1 #{ctrl_event.title}
		.event_detail
			.event_detail_item
				.event_detail_title 時間：
					span.event_detail_content #{ctrl_event.day}
				.event_detail_title 地點：
					span.event_detail_content #{ctrl_event.place}
				.event_detail_title 主辦單位：
					span.event_detail_content #{ctrl_event.owner}
				.event_detail_title 簡介：
					p.event_intro.event_detail_content
						| #{ctrl_event.description}
				.event_detail_title 活動網站：
					a.event_detail_content(href="#{ctrl_event.url}") #{ctrl_event.url}
				script.
					htmlNl2Para(".event_intro");
					parseURL(".event_intro");
			#address #{ctrl_event.place}
			#google_map

block body_script
	script(src="http://maps.google.com/maps/api/js?sensor=false")
	script(src="http://google-maps-utility-library-v3.googlecode.com/svn/trunk/infobox/src/infobox.js")
	script.
		google.maps.event.addDomListener(window, 'load', function() {
			var address = $('#address').html();

			// Get location first
			var data_location = {
				address: address,
				sensor: 'false'
			}
			$.ajax({
				url: 'http://maps.googleapis.com/maps/api/geocode/json',
				type: 'GET',
				dataType: 'html',
				data: data_location,
				async: false,
				success: function(data) {
					var json = $.parseJSON(data);
					var lat = json.results[0].geometry.location.lat;
					var lng = json.results[0].geometry.location.lng;

					// Draw the map
					console.log('Draw:', lat, lng);
					var map = new google.maps.Map(document.getElementById('google_map'), {
						zoom: 17,
						center: new google.maps.LatLng(lat, lng)
					});

					// Draw Marker
					var mapMarker = new google.maps.Marker({
						map: map,
						position: new google.maps.LatLng(lat, lng),
						title: address
					});

					// Draw InfoBox
					var mapInfobox = new InfoBox({
						content: document.getElementById('address'),
						disableAutoPan: false,
						maxWidth: 150,
						pixelOffset: new google.maps.Size(10, 0),
						zIndex: null,
						boxStyle: {
							background: "url('http://google-maps-utility-library-v3.googlecode.com/svn/trunk/infobox/examples/tipbox.gif') no-repeat",
							opacity: 0.75,
							width: '130px'
						},
						closeBoxMargin: "-8px 4px 2px 2px",
						closeBoxURL: "http://www.google.com/intl/en_us/mapfiles/close.gif",
						infoBoxClearance: new google.maps.Size(1, 1)
					});
					mapInfobox.open(map, mapMarker);

					// Comment this if you don't want a listener.
					google.maps.event.addListener(mapMarker, 'click', function() {
						mapInfobox.open(map, mapMarker);
					});
				}
			});
		});
